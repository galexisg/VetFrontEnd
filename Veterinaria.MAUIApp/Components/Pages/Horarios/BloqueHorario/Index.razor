@page "/bloques-horario/index"
@inject Veterinaria.MAUIApp.Services.BloqueHorarioService BloqueHorarioService
@inject IJSRuntime JS
@inject NavigationManager NavigationManager
@using Veterinaria.MAUIApp.Models
@using static Veterinaria.MAUIApp.Models.BloqueHorario

<div class="container py-3">
    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex gap-2">
            <!-- ⬅️ Botón para regresar a la vista principal -->
            <button class="btn btn-secondary" @onclick="RegresarInicio">
                <i class="bi bi-arrow-left"></i> Regresar
            </button>
            <h5 class="fw-bold mb-0">Bloques de horario</h5>
        </div>

        <a class="btn btn-success" href="/bloques-horario/crear">
            <i class="bi bi-plus-circle"></i> Nuevo bloque
        </a>
    </div>

    <!-- Mensaje de operación -->
    @if (!string.IsNullOrEmpty(Mensaje))
    {
        <div class="alert @AlertClass mb-3">@Mensaje</div>
    }

    <!-- Filtros -->
    <select class="form-select w-auto mb-3"
            @bind="filtroEstado"
            @bind:after="FiltrarBloques">
        <option value="Todos">Todos</option>
        <option value="Activos">Activos</option>
        <option value="Inactivos">Inactivos</option>
    </select>

    <!-- Lista de bloques -->
    @if (bloques is null)
    {
        <p>Cargando...</p>
    }
    else if (!bloques.Any())
    {
        <p>No hay bloques registrados.</p>
    }
    else
    {
        @foreach (var b in bloquesFiltrados)
        {
            <div class="card mb-2 shadow-sm">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <span>
                        <span class="badge bg-@(b.Activo ? "success" : "secondary") me-2">
                            @(b.Activo ? "Activo" : "Inactivo")
                        </span>
                        @b.Inicio.ToString(@"hh\:mm") - @b.Fin.ToString(@"hh\:mm")
                    </span>
                    <div class="d-flex gap-2">
                        <a class="btn btn-outline-primary btn-sm" href="/bloques-horario/editar/@b.Id">
                            Editar
                        </a>
                        @if (b.Activo)
                        {
                            <button class="btn btn-outline-danger btn-sm"
                                    @onclick="() => ConfirmarCambioEstado(b.Id, false)">
                                Desactivar
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-outline-success btn-sm"
                                    @onclick="() => ConfirmarCambioEstado(b.Id, true)">
                                Activar
                            </button>
                        }
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    private List<BloqueHorarioSalidaRes>? bloques;
    private List<BloqueHorarioSalidaRes> bloquesFiltrados = new();
    private string filtroEstado = "Todos";

    // 🔹 Mensajes de operación
    private string Mensaje = "";
    private string AlertClass = "alert-success";

    protected override async Task OnInitializedAsync()
    {
        await CargarBloques();
    }

    private async Task CargarBloques()
    {
        var activos = await BloqueHorarioService.ListarActivosAsync();
        var inactivos = await BloqueHorarioService.ListarInactivosAsync();

        bloques = activos.Concat(inactivos).ToList();
        FiltrarBloques();
    }

    private void FiltrarBloques()
    {
        if (bloques is null) return;

        bloquesFiltrados = filtroEstado switch
        {
            "Activos" => bloques.Where(b => b.Activo).ToList(),
            "Inactivos" => bloques.Where(b => !b.Activo).ToList(),
            _ => bloques.ToList()
        };
        StateHasChanged();
    }

    // ⬅️ Navegar a la vista principal
    private void RegresarInicio()
    {
        NavigationManager.NavigateTo("/login/menu");
    }

    // 🔹 Confirmar y cambiar estado
    private async Task ConfirmarCambioEstado(int id, bool activar)
    {
        var mensaje = activar
            ? "¿Seguro que deseas ACTIVAR este bloque?"
            : "¿Seguro que deseas DESACTIVAR este bloque?";

        var confirmar = await JS.InvokeAsync<bool>("confirm", mensaje);
        if (!confirmar) return;

        bool ok = activar
            ? await BloqueHorarioService.ActivarAsync(id)
            : await BloqueHorarioService.DesactivarAsync(id);

        if (ok)
        {
            var bloque = bloques?.FirstOrDefault(b => b.Id == id);
            if (bloque != null) bloque.Activo = activar;

            MostrarMensaje($"✅ Bloque {(activar ? "activado" : "desactivado")} con éxito");
            FiltrarBloques();
        }
        else
        {
            MostrarMensaje("❌ Ocurrió un error en la operación", false);
        }
    }

    private void MostrarMensaje(string texto, bool exito = true)
    {
        Mensaje = texto;
        AlertClass = exito ? "alert-success" : "alert-danger";
        StateHasChanged();
    }
}
