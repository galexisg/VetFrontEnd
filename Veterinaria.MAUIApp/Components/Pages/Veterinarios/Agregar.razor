@page "/veterinarios/agregar"
<<<<<<< HEAD
@using Veterinaria.MAUIApp.Services
@using Veterinaria.MAUIApp.Models
@using Veterinaria.MAUIApp.Models.Dtos
@inject VeterinarioService veterinarioService
@inject UsuarioService usuarioService
=======
@using Veterinaria.MAUIApp.Models
@inject VeterinarioService veterinarioService
>>>>>>> cce7d4c545429baff3534df3b6bc33f01fcbd981
@inject EspecialidadService especialidadService
@inject ServicioService servicioService
@inject NavigationManager nav

<link rel="stylesheet" href="css/veterinarios.css" />

<<<<<<< HEAD
<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">
                <i class="bi bi-plus-circle me-2"></i> Registrar Nuevo Veterinario
            </h5>
        </div>
        <div class="card-body">
            <EditForm Model="nuevoVeterinario" OnValidSubmit="GuardarVeterinario">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <!-- Número de licencia -->
                <div class="mb-3">
                    <label class="form-label">Número de Licencia</label>
                    <InputText class="form-control" @bind-Value="nuevoVeterinario.NumeroLicencia" />
                </div>

                <!-- Usuario -->
                <div class="mb-3">
                    <label class="form-label">Usuario</label>
                    <select class="form-select" @bind="nuevoVeterinario.UsuarioId">
=======
<div class="vet-form-container">
    <div class="vet-form-header">
        <h2>Registrar Nuevo Veterinario</h2>
    </div>

    <div class="vet-form-card">
        @if (usuarios.Count == 0 || especialidades.Count == 0 || servicios.Count == 0)
        {
            <div class="vet-alert vet-alert-info">
                <span class="vet-spinner"></span> Cargando datos...
            </div>
        }
        else
        {
            <EditForm EditContext="editContext" OnValidSubmit="GuardarVeterinario">
                <DataAnnotationsValidator />
                <ValidationSummary class="vet-validation-summary" />

                <!-- Número de licencia -->
                <div class="vet-form-group">
                    <label class="vet-form-label">Número de Licencia</label>
                    <InputText class="vet-form-input" @bind-Value="nuevoVeterinario.NumeroLicencia" />
                </div>

                <!-- Usuario -->
                <div class="vet-form-group">
                    <label class="vet-form-label">Usuario</label>
                    <InputSelect class="vet-form-select" @bind-Value="nuevoVeterinario.UsuarioId">
>>>>>>> cce7d4c545429baff3534df3b6bc33f01fcbd981
                        <option value="">-- Selecciona un usuario --</option>
                        @foreach (var user in usuarios)
                        {
                            <option value="@user.Id">@user.NombreCompleto</option>
                        }
<<<<<<< HEAD
                    </select>
                </div>

                <!-- Especialidad -->
                <div class="mb-3">
                    <label class="form-label">Especialidad</label>
                    <select class="form-select" @bind="nuevoVeterinario.EspecialidadId">
=======
                    </InputSelect>
                </div>

                <!-- Especialidad -->
                <div class="vet-form-group">
                    <label class="vet-form-label">Especialidad</label>
                    <InputSelect class="vet-form-select" @bind-Value="nuevoVeterinario.EspecialidadId">
>>>>>>> cce7d4c545429baff3534df3b6bc33f01fcbd981
                        <option value="">-- Selecciona una especialidad --</option>
                        @foreach (var esp in especialidades)
                        {
                            <option value="@esp.EspecialidadId">@esp.Nombre</option>
                        }
<<<<<<< HEAD
                    </select>
                </div>

                <!-- Servicio -->
                <div class="mb-3">
                    <label class="form-label">Servicio</label>
                    <select class="form-select" @bind="nuevoVeterinario.ServicioId">
=======
                    </InputSelect>
                </div>

                <!-- Servicio -->
                <div class="vet-form-group">
                    <label class="vet-form-label">Servicio</label>
                    <InputSelect class="vet-form-select" @bind-Value="nuevoVeterinario.ServicioId">
>>>>>>> cce7d4c545429baff3534df3b6bc33f01fcbd981
                        <option value="">-- Selecciona un servicio --</option>
                        @foreach (var serv in servicios)
                        {
                            <option value="@serv.Id">@serv.Nombre</option>
                        }
<<<<<<< HEAD
                    </select>
                </div>

                <!-- Botones -->
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle me-1"></i> Guardar
                    </button>
                    <button type="button" class="btn btn-secondary" @onclick="Cancelar">
                        <i class="bi bi-x-circle me-1"></i> Cancelar
                    </button>
                </div>
            </EditForm>

            <!-- Validaciones de carga -->
            @if (usuarios.Count == 0)
            {
                <div class="alert alert-danger mt-3">⚠️ No se cargaron usuarios.</div>
            }
            @if (especialidades.Count == 0)
            {
                <div class="alert alert-danger mt-3">⚠️ No se cargaron especialidades.</div>
            }
            @if (servicios.Count == 0)
            {
                <div class="alert alert-danger mt-3">⚠️ No se cargaron servicios.</div>
            }
        </div>
=======
                    </InputSelect>
                </div>

                <!-- Botones -->
                <div class="vet-form-actions">
                    <button type="submit" class="vet-btn vet-btn-success">
                        <i class="bi bi-check-circle"></i> Guardar
                    </button>
                    <button type="button" class="vet-btn vet-btn-secondary" @onclick="Cancelar">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                </div>
            </EditForm>
        }

        <!-- Validaciones de carga -->
        @if (usuarios.Count == 0)
        {
            <div class="vet-alert vet-alert-danger">⚠️ No se cargaron usuarios con rol Veterinario.</div>
        }
        @if (especialidades.Count == 0)
        {
            <div class="vet-alert vet-alert-danger">⚠️ No se cargaron especialidades.</div>
        }
        @if (servicios.Count == 0)
        {
            <div class="vet-alert vet-alert-danger">⚠️ No se cargaron servicios.</div>
        }
>>>>>>> cce7d4c545429baff3534df3b6bc33f01fcbd981
    </div>
</div>

@code {
    private VeterinarioGuardarReq nuevoVeterinario = new();
<<<<<<< HEAD
    private List<UsuarioRes> usuarios = new();
    private List<EspecialidadSalidaRes> especialidades = new();
    private List<ServicioRes> servicios = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            usuarios = await usuarioService.GetUsuariosAsync();
            especialidades = await especialidadService.GetActivasAsync();
            servicios = await servicioService.ObtenerActivosAsync();
=======
    private EditContext editContext;

    private List<UsuarioSalidaRes> usuarios = new();
    private List<EspecialidadSalidaRes> especialidades = new();
    private List<Servicio> servicios = new();

    protected override async Task OnInitializedAsync()
    {
        editContext = new EditContext(nuevoVeterinario);

        try
        {
            // 🔹 Solo usuarios con rol Veterinario
            usuarios = await veterinarioService.ListarUsuariosVeterinariosAsync();

            especialidades = await especialidadService.GetActivasAsync();
            servicios = await servicioService.ListarAsync(activo: true);
>>>>>>> cce7d4c545429baff3534df3b6bc33f01fcbd981
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar datos: {ex.Message}");
        }
    }

    private async Task GuardarVeterinario()
    {
<<<<<<< HEAD
        var resultado = await veterinarioService.AddAsync(nuevoVeterinario);
        if (resultado is not null)
        {
            nav.NavigateTo("/veterinarios/index");
=======
        if (!editContext.Validate())
            return;

        var ok = await veterinarioService.CrearAsync(nuevoVeterinario);
        if (ok)
        {
            nav.NavigateTo("/veterinarios/index", forceLoad: true);
>>>>>>> cce7d4c545429baff3534df3b6bc33f01fcbd981
        }
        else
        {
            Console.WriteLine("Error al guardar veterinario.");
        }
    }

<<<<<<< HEAD
    private void Cancelar()
    {
        nav.NavigateTo("/");
    }
}
=======
    private void Cancelar() => nav.NavigateTo("/veterinarios/index");
}
>>>>>>> cce7d4c545429baff3534df3b6bc33f01fcbd981
