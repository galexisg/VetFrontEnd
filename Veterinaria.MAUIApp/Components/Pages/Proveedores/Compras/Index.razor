@page "/proveedores/compras/index"
@inject NavigationManager Nav
@inject VetApp.Services.CompraService CompraService

<div class="contenedor">
    <div class="status-bar-safe-area"></div>
    <header class="mb-4">
        <p class="titulo">Compras</p>
        <p class="descripcion">Gestiona el registro de adquisiciones a proveedores</p>
    </header>

    <div class="input-container" style="display:flex;align-items:center;gap:12px;">
        <div style="flex:1;">
            <p class="titulo" style="margin-bottom:4px;">Nueva Compra</p>
            <p class="descripcion">Registra una nueva compra</p>
        </div>
        <button class="boton-verde" @onclick="@(() => Nav.NavigateTo("/proveedores/compras/agregar"))">
            Agregar
        </button>
    </div>

    <div class="input-container" style="display:flex;gap:12px;align-items:center;">
        <div style="position:relative;flex:1;">
            <input class="input" placeholder="Buscar compras por proveedor o fecha..." @bind="FiltroBusqueda" />
            <span style="position:absolute;right:12px;top:50%;transform:translateY(-50%);color:#5D5D5D;">🔍</span>
        </div>
    </div>

    @if (Compras == null)
    {
        <p>Cargando compras...</p>
    }
    else if (!Compras.Any())
    {
        <p>No se encontraron compras.</p>
    }
    else
    {
        @foreach (var c in Compras)
        {
            <div style="background:var(--blanco);border:1px solid var(--borde);border-radius:12px;padding:12px;margin-bottom:12px;">
                <p class="titulo" style="margin-bottom:4px;">Proveedor: @c.ProveedorId</p>
                <p class="descripcion" style="margin-bottom:12px;">Fecha: @c.Fecha.ToShortDateString() | Usuario: @c.UsuarioId</p>

                <div style="display:flex;gap:8px;">
                    <button class="boton-verde" style="flex:1;"
                            @onclick="@(() => Nav.NavigateTo($"/proveedores/compras/editar/{c.Id}"))">
                        Editar
                    </button>
                    <button class="boton-rojo" style="flex:1;"
                            @onclick="@(() => EliminarCompra(c.Id))">
                        Eliminar
                    </button>
                </div>
            </div>
        }
    }
</div>

@code {
    private List<VetApp.Models.Compra> Compras;
    private string FiltroBusqueda = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await CargarCompras();
    }

    private async Task CargarCompras()
    {
        Compras = await CompraService.ObtenerTodasAsync();
    }

    private async Task EliminarCompra(long id)
    {
        var cancelar = new VetApp.Models.CompraCancelar
        {
            MotivoCancelacion = "Eliminado desde la app"
        };

        await CompraService.CancelarAsync(id, cancelar);
        await CargarCompras(); // Recargamos la lista después de eliminar
    }
}
